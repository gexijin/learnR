# The messy salary data

Welcome to the world of payroll data! Our current focus is a somewhat chaotic dataset, sourced from [repository](https://data.ct.gov/Government/State-Employee-Payroll-Data-Calendar-Year-2015-thr/virr-yb6n/data), featuring Connecticut's state employees' payment from Calendar Year 2015 to the latest pay period. We randomly selected 8500 employees in fiscal year 2017 and saved it in [state_empoyee_salary_data_2017.csv](https://github.com/gexijin/learnR/blob/master/datasets/state_employee_salary_data_2017.csv).
Our mission is to demystify the correlation between income and an array of intriguing variables.

## Data Preparation and Cleaning
First things first, let’s tidy up our data. We will focus on the full-time employees and the favorable variables like various incomes, Age, Sex, Ethnic, Union description, and so on.

```{r message=FALSE, warning=FALSE, echo=FALSE}
salary <- read.csv("datasets/state_employee_salary_data_2017.csv")
```

```{r eval=FALSE}
salary <- read.csv("state_employee_salary_data_2017.csv")
```

```{r message=FALSE, warning=FALSE}
salary <- subset(salary, Full.Part == "F")  # Select full time employees
salary <- salary[, c(4, 10, 14, 24:25, 28:31, 37)]  # Keep only the interested variables
```

Let's break down the key variables to understand what each one represents:

- **EmplId.Empl.Rcd**: Employee's personal barcode, unique identifier for every individual
- **Check.Dt**: The date each paycheck was issued.
- **Bi.Weekly.Comp.Rate**: The bi-weekly salary rate.
- **Tot.Gross**: The total gross income.
- **Age**: Employee's age.
- **Job.Indicator**: Indicator of the nature of the job. 
- **Ethnic.Grp**: Ethnic background of the employee.
- **Sex**: Gender of the employee.
- **Full.Part**: Category of the job. "F" for Full-time, "P" for Part-time.
- **Union.Descr**: The union description of the employee.

It's important to factorize the categorical variables first.
```{r}
salary$EmplId.Empl.Rcd <- as.factor(salary$EmplId.Empl.Rcd)
salary$Sex <- as.factor(salary$Sex)
salary$Ethnic.Grp <- as.factor(salary$Ethnic.Grp)
salary$Union.Descr <- as.factor(salary$Union.Descr)
```

Now we will explore the pay checks' distribution.

(ref:salary-EmployeeCount) Situation of check occurrence of employees.

```{r salary-EmployeeCount, fig.cap='(ref:salary-EmployeeCount)', fig.align='center'}
EmplId.Empl.Rcd <- as.character(salary$EmplId.Empl.Rcd)
counts <- data.frame(table(EmplId.Empl.Rcd))
PersonOccurCount <- table(counts[, 2])
plot(PersonOccurCount, col = rainbow(30), 
     xlab = "Occurance of employee", ylab = "Count of employee")
```

Most employees were paid 26 times. Let’s remove the employees not receiving 26 pay checks.

```{r}
subEmpl <- subset(counts, Freq != 26)
id <- which(salary$EmplId.Empl.Rcd %in% subEmpl$EmplId.Empl.Rcd)
salary <- salary[- id, ]
```

Let's display the distribution of the dates the checks were issued.

(ref:salary-CheckCount) The counts of checks for check date in 2017.

```{r salary-CheckCount, fig.cap='(ref:salary-CheckCount)', fig.align='center'}
Check.Dt <- gsub(" 12:00:00 AM", "", salary$Check.Dt)
counts <- table(Check.Dt)
barplot(counts, col = rainbow(26), axis.lty = 1, xlab = "Check Date", ylab = "Count")
```

The counts of checks for bi week are consistent, except a curious dip on 03/08/2017. Let's gently nudge these anomalies out of our data.

```{r }
subEmpl <- salary[which(salary$Check.Dt == "03/08/2017 12:00:00 AM"), ]
salary <- salary[- which(salary$EmplId.Empl.Rcd == subEmpl$EmplId.Empl.Rcd), ]
```

Next, we inspect for any mismatched gender data.
```{r warning=FALSE, message=FALSE}
library(dplyr)
dupliSex_count <- salary %>%
  group_by(EmplId.Empl.Rcd, Sex) %>%
  summarise(Total.Gross = sum(Tot.Gross), .groups = "drop") %>%
  add_count(EmplId.Empl.Rcd) %>%
  filter(n > 1) %>%
  summarise(duplicated_count = n()) 
```

Zero duplicated_count indicates no gender data mix-ups. But is there a mysterious "U" gender lurking?

```{r}
nrow(salary[which(salary$Sex == "U"), ])
```

No "U" gender found now. They should have been removed in previous steps. Next, let’s examine the ethnic group duplication.

```{r warning=FALSE, message=FALSE}
dupliEthnic_count <- salary %>% 
  group_by(EmplId.Empl.Rcd, Ethnic.Grp) %>%
  summarise(Total.Gross = sum(Tot.Gross), .groups = "drop") %>%
  add_count(EmplId.Empl.Rcd) %>%
  filter(n > 1) %>%
  summarise(duplicated_count = n())
```

Again, Zero duplication! It confirms our dataset's integrity regarding gender and ethnicity.

But hold on, we’ve got folks with gross incomes or biweekly rates in the negative zone. How curious!

```{r}
subGross <- subset(salary, Tot.Gross <= 0 | Bi.Weekly.Comp.Rate <= 0)
unique_ids <- unique(subGross$EmplId.Empl.Rcd)
salary <- salary[- which(salary$EmplId.Empl.Rcd %in% unique_ids), ]
```

We waved goodbye to those cases with impossible financial figures. Now let's check the distribution of total gross.

(ref:salary-TotGross) Scatterplot and lagplot of total gross income.

```{r salary-TotGross, fig.show='hold', out.width='50%', fig.cap='(ref:salary-TotGross)', fig.align='center'}
plot(salary$Tot.Gross)
lag.plot(salary$Tot.Gross)
```

Both scatter plot and lag plot reveal a cozy congregation of salaries under \$20000, with a few adventurous ones rocketing past \$60000.

Next on our cleaning checklist: employees with the mysterious Job Indicator "S".

```{r}
subGross <- subset(salary, Job.Indicator == "S")
unique_ids <- unique(subGross$EmplId.Empl.Rcd)
salary <- salary[- which(salary$EmplId.Empl.Rcd %in% unique_ids), ]
```

Employees marked with "S" have left the building. 
Now, let's deal with those duplicated union descriptions.
```{r}
dupliUnion <- salary %>%
  group_by(EmplId.Empl.Rcd) %>%
  summarise(UnionCount = n_distinct(Union.Descr), .groups = "drop") %>%
  filter(UnionCount > 1) %>%
  select(EmplId.Empl.Rcd)
salary <- salary %>%
  anti_join(dupliUnion, by = "EmplId.Empl.Rcd")
```

Finally, with our data now squeaky clean, let's take one last look, focusing on important variables like sex, ethnicity, union, age, total gross, and biweekly rate. Let's round off the age to keep it neat.
```{r message=FALSE}
salary <- salary %>% 
  group_by(EmplId.Empl.Rcd, Sex, Ethnic.Grp, Union.Descr) %>% 
  summarise(Age = round(mean(Age), 0), Tot.Gross = mean(Tot.Gross), 
            Bi.Weekly.Rate = mean(Bi.Weekly.Comp.Rate)) %>%
  group_by(EmplId.Empl.Rcd) %>% 
  filter(n() == 1) %>% 
  droplevels()
str(data.frame(salary))
```

One last tweak: there is one level marked as "" in ethnic group. Let's label it as "unknown".
```{r}
levels(salary$Ethnic.Grp)[levels(salary$Ethnic.Grp) == ""] <- "unknown"
```

And there we have it! Our data is now primed and ready for the analytical spotlight.
Let's take a moment to summarize our polished data.
```{r}
summary(salary)
```

After cleaning, we're left with 3,441 employees, each with a unique set of characteristics. Our dataset now reflects a diverse sex group, ranging from 22 to 81 years old, belonging to 8 different ethnicities and 54 unions. The financial landscape they inhabit is vast: The minimum total gross is \$568.7 and the maximum is \$17530.3. The biweekly rate ranges from \$25.78 to \$12884.62. The income varies significantly, offering us a rich field for analysis.


We'll now focus on exploring the total gross income of these employees. A series of compelling questions guide our journey: How about the patterns of the total gross income? Are males and females paid equally? Is there a correlation between the numbers on the paycheck and the candles on the birthday cake? Does one's ethnic background play a role in their earning potential? What's the most important factor affecting the state employees' gross income?

First, let's dive into the detailed information of these variables.

## Variable Analysis
### Income and age

From the preliminary analysis(Figure 10.3), we notice that "Tot.Gross" is not randomly scattered. Let's log-transform it for better insights.
```{r}
salary$Gross.Log <- log(salary$Tot.Gross)
```

(ref:salary-HistQQ) Histogram and QQ plots for total gross, log of gross and age.

```{r salary-HistQQ, fig.width=10, fig.height=8, fig.cap='(ref:salary-HistQQ)', fig.align='center'}
variable <- c("Tot.Gross", "Gross.Log", "Age")  # Pick up the numeric columns
par(mfrow = c(3, 2))  # Layout in 3 rows and 2 columns
for (i in 1:length(variable)){
  sub <- unlist(salary[variable[i]])
  submean <- mean(sub)
  hist(sub, main = paste("Hist. of", variable[i], sep = " "), xlab = variable[i])
  abline(v = submean, col = "blue", lwd = 1)
  qqnorm(sub, main = paste("Q-Q Plot of", variable[i], sep = " "))
  qqline(sub) 
  if (i == 1) {
    s.t <- shapiro.test(sub)
  } else {
    s.t <- rbind(s.t, shapiro.test(sub))
 }
}
s.t <- s.t[, 1:2]  # Take first two columns of shapiro.test result
s.t <- cbind(variable, s.t) # Add variable name for the result
s.t
```

Our findings reveal that while total gross income is left-skewed, the log-transformed gross gravitates closer to normal distribution. The age distribution, resembling a bell curve, is primarily clustered in the 45-50 years range. Yet, the Shapiro tests challenge our assumptions of normality.

Let's now turn our attention to the ethnic composition of the dataset.

### Ethnic group
```{r warning=FALSE}
library(ggplot2)
counts <- data.frame(sort(table(salary$Ethnic.Grp), decreasing = TRUE))
perc <- paste(round(counts$Freq/sum(counts$Freq), 2)*100, "%", sep = "")
ggplot(counts, aes(x = reorder(Var1, Freq), y = Freq)) +
  geom_bar(stat = 'identity', fill = rainbow(8)) + 
  geom_text(aes(x = c(8:1), y = Freq + 100 , label = perc), size = 3.5) +
  labs(x = 'Ethnic Group', y = 'Freqency', title = 'Ethnic group by count') +  
  theme_bw() +  # Classic dark-on-light
  coord_flip() +  # Flip the plot
  theme(plot.title = element_text(hjust = 0.5)) 
```

Our data shows a significant majority (61%) of state employees are White, followed by 14% Black. AMIND and PACIF, however, are represented in significantly smaller numbers.

### Sex
Next, we explore the gender distribution.
```{r warning=FALSE, message=FALSE}
library(plotrix)
counts <- sort(table(salary$Sex), decreasing = TRUE)
# Labels with count number and percentage
percentage <- paste(round(counts/sum(counts), 2)*100, "%", sep = "")
labels <- paste(names(counts), "\n", counts, percentage, sep = "  ") 
pie3D(counts, labels = labels, explode = 0.05,
    main = "Pie chart of sex", labelcex = 1.0, labelpos = c(1.8, 5.0))
```

Interestingly, females outnumber males by about 4% in our dataset.

### Union descreption
Lastly, let's analyze the top unions both by count and average gross income.
```{r warning=FALSE}
top10Union <- data.frame(sort(table(salary$Union.Descr), decreasing = TRUE)[1:10]) # By count
names(top10Union)[1] <- "Union.Descr"
topUnion <- salary %>%
  group_by(Union.Descr) %>%
  summarise(Avg.Gross.Log = round(mean(Gross.Log), 3)) %>%
  arrange(desc(Avg.Gross.Log)) %>%
  head(10)   #by average gross sales
UnionCountGross <- data.frame(top10Union, topUnion) 
names(UnionCountGross)[1]<- "Top unions by count"
names(UnionCountGross)[3]<- "Top unions by log of gross"
library(knitr)
kable(UnionCountGross, booktabs = TRUE, caption = "Top unions by count and average log value of gross")
```

The most populous unions include Service Maintain, Correctional officers, and Social & Human Services. However, when ranked by average gross, the top unions largely consist of those from universities or colleges. Interestingly, except for the Managerial union, the top 10 unions by count are significantly different from those by average gross income.

## Analysis of gross income
### Age
Let's examine how age influences gross income.

(ref:salary-GrossAge) Average gross and log of gross distribution by age.

```{r warning=FALSE, salary-GrossAge, message=FALSE, fig.width=10, fig.height=5, fig.cap='(ref:salary-GrossAge)', fig.align='center'}
# Get bar plot
AgeBar <- salary %>% 
  group_by(Age) %>%
  summarise(Avg.Gross = mean(Tot.Gross)) %>%
  ggplot(aes(x = Age, y = Avg.Gross)) +
  geom_bar(stat = 'identity', col = "lightblue", fill = "blue") + 
  scale_x_continuous(breaks = seq(20, 90, 10)) +
  labs(y = "Average gross income")
# Get density2D plot
AgeDensity <- ggplot(salary, aes(x = Age, y = Gross.Log)) + 
  stat_density2d(aes(fill = ..density..^0.25), geom = "tile", contour = FALSE, n = 200) +  
  scale_fill_continuous(low = "white", high = "dodgerblue3") +
  scale_x_continuous(breaks = seq(10, 100, 10)) +
  scale_y_continuous(breaks = seq(2, 12, 1)) +
  theme(legend.position = "none", panel.background = element_blank())
# Display two plots in the same row
library(gridExtra)
grid.arrange(AgeBar, AgeDensity, nrow = 1)
```

We observe that older employees tend to earn more, with the average gross income hovering around $3000. The density plot reveals a concentration of employees with a log gross income near 8.

For a granular view, we break age down into decade-long categories:
```{r}
salary$AgeGroup <- cut(salary$Age, breaks = c(10, 20, 30, 40, 50, 60, 70, 80, 90), right = FALSE)
```

(ref:salary-LogGrossAge1) Distribution of log gross income by age group.

```{r salary-LogGrossAge1, fig.cap='(ref:salary-LogGrossAge1)', fig.align='center'}
stat <- salary %>% group_by(AgeGroup) %>% summarise(Avg.Gross.Log = mean(Gross.Log)) 
ggplot() + 
  geom_boxplot(data = salary, aes(x = AgeGroup, y = Gross.Log, fill = AgeGroup)) + 
  geom_point(data = stat, aes(x = AgeGroup, y = Avg.Gross.Log), color = "brown") +
  geom_text(data = stat, 
            aes(label = round(Avg.Gross.Log, 2), x = AgeGroup, y = Avg.Gross.Log - 0.1))
```

With each decade, there's a steady increase in log gross income, except in the 80-90 age group，reflecting the progression and experience gained over years of service. 

```{r}
model <- aov(salary$Gross.Log~salary$AgeGroup)
summary(model)
```

A p-value significantly less than 0.05 in our ANOVA analysis reveals significant differences in mean log gross income across age groups.

```{r message=FALSE, warning=FALSE}
library(agricolae)
# LSD.test needs to provide degrees of freedom and mean square for errors. We can get it from aov.
res <- LSD.test(salary$Gross.Log, salary$AgeGroup, 
                DFerror = model$df.residual, MSerror = anova(model)[["Mean Sq"]][2])  
res$groups
```

Pairwise comparisons confirm that each age group significantly differs from the others in mean log gross income. The elder the age, the higher the log gross income, except the 80-90 group, which surprisingly has the lowest mean log gross. 

Next, we explore union descriptions by age group.

(ref:salary-UnionAge) Percentage of union descriptions by age group.

```{r salary-UnionAge, message=FALSE, warning=FALSE, fig.width=8, fig.height=8, fig.cap='(ref:salary-UnionAge)', fig.align='center'}
library(scales)
library(plotly)
AgePercBar <- salary %>%
  group_by(Union.Descr, Age) %>%
  summarise(Avg.Gross = mean(Gross.Log)) %>%
  arrange(desc(Avg.Gross)) %>%
  ggplot(aes(x = Age, y = Avg.Gross, fill = Union.Descr)) +
  geom_bar(stat = "identity", position = "fill") +
  scale_y_continuous(labels = percent_format()) +
  scale_x_continuous(breaks = seq(10, 100, 10)) +
  labs(y = "Percentage") +
  theme(panel.background = element_rect(fill = "black"),
  panel.grid.major = element_blank(), panel.grid.minor = element_blank())
ggplotly(AgePercBar)
```

Our interactive plot paints a vivid picture of union representation across different ages. For example, younger employees at 22 display a balanced mix in several unions(Administrative Clerical, Exempt/Elected/Appointed, Service/Maintenance and UCHC Univ Hlth Professional), whereas the 81-year-olds predominantly align with one (Legislative Management).

### Sex
Our analytical journey now turns to a critical aspect: the comparison of gross income between genders. 

(ref:salary-GrossSex) Log of gross comparison by sex group.

```{r salary-GrossSex, fig.width=8, fig.height=4, fig.cap='(ref:salary-GrossSex)', fig.align='center'}
par(mfrow = c(1, 2))
# Density plot for each sex
SubFemale <- salary[which(salary$Sex == "F"), ]
SubMale <- salary[which(salary$Sex == "M"), ]
plot(density(SubFemale$Gross.Log), col = "red", xlab = "Log of Gross", 
     main = "Density plot for each sex")
lines(density(SubMale$Gross.Log), col = "blue")  # Add density line of SubMale to density plot of SubFemale
legend("topright", c("M","F"), lty = c(1, 1), col = c("blue", "red"))  # Add legend
# LSD comparison for sex group
model <- aov(salary$Gross.Log~salary$Sex)
res <- LSD.test(salary$Gross.Log, salary$Sex, 
                DFerror = model$df.residual, MSerror = anova(model)[["Mean Sq"]][2]) 
gross <- round(res$groups[, "salary$Gross.Log"], 2)
plot(res, xlab = "Sex Group", ylab = "Range between max and min", 
     main = "Sex groups and variation range")
text(x = c(seq(from = 1, to = 10, by = 1.2)), y = 8, gross)
```

The blue male line in the density plot overtakes the red female line, indicating higher male income. The earlier density peak of the female group also tells the same story.
The variation range plot, with its distinct alpha-beta index, further emphasizes that these sex groups differ significantly in mean log gross income. Yes, the numbers speak: males earn more than females.

(ref:salary-EthnicSex1) Log of gross comparison by ethnic and sex group.

```{r salary-EthnicSex1, message=FALSE, warning=FALSE, fig.width=10, fig.height=4, fig.cap='(ref:salary-EthnicSex1)', fig.align='center'}
# Produce the point and line plot 
PointLine <- salary %>%
  group_by(Ethnic.Grp, Sex) %>%
  summarise(Avg.Gross = mean(Gross.Log)) %>%
  ggplot(aes(x = Ethnic.Grp, y = Avg.Gross, colour = Sex, group = Sex)) + 
  geom_line(size = 1) +
  geom_point(size = 4, shape = 19) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), 
        panel.grid.major = element_blank(), 
        legend.position = "bottom") +
  labs(x = "Ethnic Group", y = "Average Gross Log")
# Produce the density ridge plot 
library(ggridges)
DensityRidge <- salary %>% group_by(Ethnic.Grp, Sex) %>%
  ggplot(aes(x = Gross.Log, y = Ethnic.Grp,  fill = Sex)) +
  geom_density_ridges(alpha = 0.55) +
  theme(legend.position = "bottom") +
  xlim(6.0, 10.0)
# Lay out two plots in the same row
library(gridExtra)
grid.arrange(PointLine, DensityRidge, nrow = 1)
```  

The plots unveil a consistent trend: in most ethnic groups, males outearn females, with the AMIND group showing a stark contrast. However, Asian females break this pattern, earning on par with their male counterparts. The small number of PACIF employees results in their absence from the density-ridge plot.

(ref:salary-Diverging) Diverging bars of stanardized log of gross income.

```{r salary-Diverging, fig.width=8, fig.height=8, fig.cap='(ref:salary-Diverging)', fig.align='center'}
# Standardize Gross.Log first. Separate into two groups "Below average" and "Above average"
Sd.Gross <- round((salary$Gross.Log - mean(salary$Gross.Log)) / sd(salary$Gross.Log), 2)
Gross.Type <- ifelse(Sd.Gross < 0, "Below average", "Above average")
Sex <- salary$Sex
Category <- salary$Union.Descr
GrossUnionSex <- data.frame(Category, Sd.Gross, Gross.Type, Sex)

ggplot(GrossUnionSex, aes(x = Category, y = Sd.Gross)) + 
  geom_bar(stat = 'identity', aes(fill = Gross.Type), width = .5)  +
  facet_wrap(~ Sex) +   # Arrange panels according to sex
  labs(x = "Union Descreption", y = "Standardized log of gross") + 
  coord_flip() +   # Horizontal plot
  theme(legend.position = "top")
```

These bars lay bare the income distribution within unions, irrespective of gender. For example, more Uconn-Faculty are paid above the average; more UCHC Univ Hlth Professionals are paid below the average; while for Social and Human Services, it's half and half. 
The plots also indicate that certain unions, regardless of gender, tend to lean towards paying either below or above the average. For instance, Administrative Clerical and service/maintenance tend to pay below average, while others like Managerial and Health Professional are on the higher end of the pay scale. 

In our next phase of analysis, we focus on the intriguing interplay between gross income and ethnic groups. 

### Ethnic Group

(ref:salary-Ethinic1) Bar and density ridge plot of log of gross by ethnic.

```{r salary-Ethinic1, fig.width=10, fig.height=4, message=FALSE, fig.cap='(ref:salary-Ethinic1)', fig.align='center'}
# Bar plot with error bar for different ethnic group
EthnicBar <- salary %>% 
  group_by(Ethnic.Grp) %>%
  summarise(mean = mean(Gross.Log),
            sd = sd(Gross.Log),
            se = sd(Gross.Log)/sqrt(n())) %>%
  ggplot(aes(x = Ethnic.Grp, y = mean, color = Ethnic.Grp, fill = Ethnic.Grp)) +
  geom_bar(stat = "identity") +
  geom_errorbar(aes(ymin =mean - se, ymax =mean + se), color = "black", width = 0.3) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
# Density ridges for different ethnic group
EthnicDensity <- salary %>% group_by(Ethnic.Grp) %>%
  ggplot(aes(x = Gross.Log, y = Ethnic.Grp, color = Ethnic.Grp, fill = Ethnic.Grp)) +
  geom_density_ridges(alpha = 0.5) +
  xlim(6.0, 10.0) +
  coord_flip() +
  theme(legend.position = "none")
# Display two plots in same row 
grid.arrange(EthnicBar, EthnicDensity, nrow = 1)
```

The bar plot reveals that Asian, Nspec, and White ethnic groups have higher average gross incomes, with Pacif and Unknown on the lower end. The variance among ethnic groups is notably distinct, with Pacif and Amind showing the most significant differences.
The density ridge plots further depict diverse income distributions across ethnicities. Asian exhibits the biggest density above log of gross of 8.5, while unknown falls mostly below 8. Ethnic groups of white, black, and unknown show relatively symmetrical density distribution. 


(ref:salary-EthnicRank) Ethnic rank plot by count and log of gross.

```{r salary-EthnicRank, message=FALSE, fig.cap='(ref:salary-EthnicRank)', fig.align='center'}
# Get ethnic order according to the frequency of count
CountEthnic <- data.frame(sort(table(salary$Ethnic.Grp), decreasing = TRUE))

# Get ethnic order according log of gross income
GrossEthnic <- salary %>%
  group_by(Ethnic.Grp) %>%
  summarise(Avg.Gross = mean(Gross.Log)) %>%
  arrange(desc(Avg.Gross)) %>%
  pull(Ethnic.Grp)

# build data frame for rank of these two ethnic order
EthnicGroup <- unlist(list(CountEthnic[, 1], GrossEthnic))
Rank <- rep(1:8, 2)
EthnicType <- rep(c("CountEthnic","GrossEthnic"), each = 8)
EthnicRank <- data.frame(Rank, EthnicType, EthnicGroup)

# point plot two set of ethnics according rank and connect same ethnic by line
ggplot(EthnicRank, aes(y = Rank, x = EthnicType, label = EthnicGroup, group = EthnicGroup) )+
  geom_line(size = 1) +
  geom_point(aes(color = EthnicGroup), size = 5) +
  scale_y_continuous(breaks = seq(0, 10, 1)) +
  annotate("text", x = 0.7, y = Rank[1:8], label = EthnicGroup[1:8], hjust = 0, cex = 3.5) +
  annotate("text", x = 2.1, y = Rank[9:16], label = EthnicGroup[9:16], hjust = 0, cex = 3.5)
```
White and Black employees dominate the workforce in numbers, while Asians lead in average gross income. Pacif consistently ranks lowest in both categories. Interestingly, the ranking by income notably differs from those by count.

```{r warning=FALSE, fig.width=6, fig.height=6}
model <- aov(Gross.Log ~ Ethnic.Grp, data = salary)
tukey <- TukeyHSD(model)
par(mar = c(4, 10, 2, 1))
psig <- as.numeric(apply(tukey$Ethnic.Grp[, 2:3], 1, prod) >= 0) + 1
plot(tukey, col = psig, las = 1, cex.axis = 0.7, yaxt = "n")
for (j in 1:length(psig)){
  axis(2, at = j,labels = rownames(tukey$Ethnic.Grp)[length(psig) - j + 1],
       las = 1, cex.axis = .8, col.axis = psig[length(psig) - j + 1])
}
```

The Tukey HSD test uncovers significant differences in income among various ethnic pairs, like unknown with Asian, Black, Nspec and White; Asian with Black, Hispa and White; Black with Hispa and White; Hispa with Nespa and White.

```{r}
ggplot(salary, aes(x = Age, y = Gross.Log, colour = Sex, shape = Sex)) +
  geom_point() +
  ggtitle("Scatterplot of log of gross vs Age by Sex and Ethnic") +
  facet_wrap(~ Ethnic.Grp) +  # Arrange panels by Ethnic Group
  geom_smooth(aes(colour = Sex), method = 'lm',formula = y ~ x)  +  # Add the regression line
  theme(plot.title = element_text(hjust = 0.5), legend.position = c(0.85, 0.15))
```

Finally, a scatterplot analysis of gross income vs. age by sex and ethnic group provides further insights, revealing patterns and disparities across different demographics.
In conclusion, White employees are the most numerous, while the Pacif group is scarcely represented; Across ethnic groups, there's a general trend of increasing log gross income with age. However, this pattern varies by sex within each ethnic group. Some groups, like Unknown and Amind, show faster income increases for males, whereas in groups like Asian, females experience a quicker rise in earnings.
 

## Analysis of gross income types
In this section, we delve into the categorization of gross income types and examine the effects of age, sex, and ethnicity on income.  

### Defining Gross income types
We start by dividing employees into three distinct income groups:


1 **High.Gross**: Average log of gross greater than 8.5


2 **Middle.Gross**: Average log of gross between 7.8 and 8.5


3 **Low.Gross**: Average log of gross equal to or less than 7.8
```{r}
salary <- salary %>%
  mutate(Gross.Type = case_when(
    Gross.Log > 8.5 ~ "High",
    Gross.Log > 7.8 ~ "Middle",
    TRUE ~ "Low"
  ))
```

Let's now analyze each gross type for employee count, percentage distribution, and average incomes.

```{r warning=FALSE, message=FALSE}
library(janitor)
GrossIncome <- salary %>%
  group_by(Gross.Type) %>%
  summarise(
    Count = n(),
    Avg.Log.Gross = round(mean(Gross.Log), 2),
    Avg.Tot.Gross = round(mean(Tot.Gross), 2),
  ) %>%
  mutate(
    Percent = round(Count / sum(Count), 2),
    Gross.Type = c("High, Gross.Log > 8.5", 
                   "Middle, Gross.Log > 7.8", 
                   "Low, Gross.Log <= 7.8")
  ) %>%
  arrange(desc(Avg.Log.Gross)) %>%
  select(Gross.Type, Count, Percent, Avg.Log.Gross, Avg.Tot.Gross)
kable(GrossIncome, booktabs = TRUE, caption = "Table of gross type")
```


```{r}
GrossIncome$Gross.Type <- factor(GrossIncome$Gross.Type, levels = GrossIncome$Gross.Type)
ggplot(GrossIncome, aes(x = Gross.Type,
       label = paste(Avg.Tot.Gross, paste(Percent*100, "%", sep = ""), sep = ",   "))) +
  geom_bar(aes(y = Count), stat = "identity", fill = rainbow(3)) +
  geom_line(aes(y = Avg.Log.Gross*250, group = 1, colour = "Avg.Tot.Gross*250"), size = 2) +
  geom_point(aes(y = Avg.Log.Gross*250, group = 1, colour = "Avg.Tot.Gross*250"), size = 4) +
  labs(x = "Gross Type", y = "Employee Number", 
       title = "Average gross and employee distribution for each gross type") +
  theme(plot.title = element_text(hjust = 0.5)) +
  geom_text(x = c(1, 2, 3), y = c(2000, 1900, 1800), size = 4, color = "black")
```

As it turns out, the high gross group makes up a mere 6% of the workforce, with the middle group claiming a substantial 68%, and the low gross group rounding out the remaining 26%. The average total gross income takes a nosedive from 6,307 dollars bi-weekly in the high gross group to 3,380 and then to 2,066 for the middle and low groups, respectively. This disparity highlights a threefold income difference between the high and low gross categories.

### The Intersection of Ethnic, Sex and age
```{r}
salary %>% 
  mutate(EthnicSex = paste(Ethnic.Grp, Sex, sep = "-")) %>%
  tabyl(EthnicSex, Gross.Type,  show_missing_levels = FALSE) %>%
  adorn_totals("row") %>%
  adorn_totals("col") %>%
  adorn_percentages("all") %>%
  adorn_pct_formatting(digits = 1) %>%
  adorn_ns %>%
  adorn_title 
```

In high gross type, white males take the lion's share. Other ethnic groups see a more balanced or even female-dominated representation in the high gross category. For middle and low gross types, females generally outnumber males, except in the white ethnic group.
Over half of the employees in most ethnic groups fall into the middle gross type, with the unknown group showing a higher propensity towards the low gross type.
 
```{r warning=FALSE}
library(ggmosaic)
h_mosaic <- ggplot(data = salary) +
  geom_mosaic(aes(x = product(Sex, Ethnic.Grp), fill = AgeGroup), 
              na.rm = T, divider = mosaic("h")) +
  theme(plot.title = element_text(hjust = 0.5), 
        axis.text.x = element_text(angle = 90, size = 6),
        legend.position="top",legend.text=element_text(size = 6),
        panel.background = element_rect(fill="black"), panel.grid.major = element_blank()) + 
  labs(x = "", y = "", title= "Mosaic Plot for Gross Group by Ethnic and Sex Group") +
  facet_grid(Gross.Type ~ .)
ggplotly(h_mosaic, width = 750, height = 500) %>%
  layout(legend = list(orientation = "h", y = 1))
```

Our mosaic plot vividly illustrates the age, sex, and ethnic diversity within each gross income type. Elderly males, particularly those aged 70-80, are more prevalent in the high gross group. On the other side, white ethnic group dominates more than half sharing in high and middle gross groups, but less than half in low gross group. The other ethnics groups share the remaining distribution in each gross income type.


##  LM and ANOVA analysis

In our quest to decode the complexities of state employee salaries, we now turn to statistical modeling. Our goal is to understand how factors like age, ethnicity, sex, and union affiliation influence the log of gross income.
We begin by prepping our data for the linear model:
```{r}
# Remove first col. of EmplId.Empl.Rcd and other variables
salaryglm <- salary[, - c(1, 6:7, 9:10)] 
str(salaryglm)
```

We employ a linear model (LM) and an ANOVA analysis to dissect the relationship between our variables and gross income:
```{r warning=FALSE }
modelLM <- lm(Gross.Log ~ ., data = salaryglm)
ss <- coef(summary(modelLM))  # Take only coefficient of summary
ss.sig <- ss[ss[, "Pr(>|t|)"] < 0.05, ][1:20, ]  # Show first 20 coefficient with p < 0.05
ss.sig
# Show Adjusted R-squared value
statistic <- paste("Adjusted R-squared",round(summary(modelLM)$adj.r.squared, 4), sep = ": ")
statistic
modelANOVA <- aov(Gross.Log ~ ., data = salaryglm)
summary(modelANOVA)
```

Both the LM and ANOVA models confirm that age, union affiliation, sex, and ethnicity play significant roles in determining gross income. It appears these variables are crucial pieces of the income puzzle.

## Conclusion

- **Income Distribution**: Gross income leans leftward in its distribution, with log gross income fitting more snugly into a normal distribution.

- **Age and Income**: Age positively correlates with income, though this trend dips in the 80-90 age bracket.

- **Gender Pay Gap**: Males, on average, earn more than females across similar age, ethnic, and union groups.

- **Ethnicity and Earnings**: In the earnings race, Asians and Whites are leading the pack, while the PACIF and unknown groups trail behind.

- **Income Groups**: The high, middle, and low gross groups make up 6%, 68%, and 26% of the workforce, respectively. White males are particularly prominent in the high gross group, especially those older individuals.

- **Predictive Factors**: The combined factors of age, union, sex, and ethnicity account for around 50% of the variance in log gross income—a substantial but not all-encompassing influence.


Now it's your turn to jump into the data and see what stories it tells.

>
```{exercise}

>
Create a folder, download the data file "state_empoyee_salary_data_2017.csv" into it, and create an Rstudio project in the folder. Read in the data file, peak the structure of your data set, clean it and explore the dataset step by step:
>  
a. Select only columns of "EmplId.Empl.Rcd", "Bi.Weekly.Comp.Rate", "Age", "Ethnic.Grp", "Sex", "Full.Part", "City", get summary information for all these variables. Make sure "EmplId.Empl.Rcd", "Sex", "Ethnic.Grp" to be factors, "Age" and "Bi.Weekly.Comp.Rate" to be numerics.
b. Pick up full-time employees in the city "Hartford".
c. Focus on only those employees with 26 paychecks for the 2017 fiscal year(Hint: Each employee has a unique ID of "EmplId.Empl.Rcd"). 
d. Remove sex group other than "F" and "M" if there is any. Hint: Use str() after droplevels().
e. Label level of empty space in "Ethnic.Grp" as “unknown”.
f. Exclude employees with non-positive "Bi.Weekly.Comp.Rate" if there is any.
g. Group your data set by "EmplId.Empl.Rcd", "Ethnic.Grp", and "Sex". For each employee, 
calculate average age and bi-weekly rate. Round the means to the nearest integer and rename them as "Age" and "Bi.Weekly.Rate".
h. Explore data structure and summary. 
i. Viualize the distribution of "Bi.Weekly.Rate" and "Age" using histogram and QQ plots. Test the normality. Make log transformation if it is necessary.
j. Use a pie plot for distribution of "Sex".
k. List the count number and percent of employees in each ethnic group. 
l. conjure up a scatter plot to review the relationship between average "Bi.Weekly.Rate" and "Age", add a regression line and give your interpretation.
m. Employ a box plot for the relationship between "Bi.Weekly.Rate" and Ethnic groups.
n. Create a density plot similar to Figure \@ref(fig:salary-GrossSex) for the distribution of "Bi.Weekly.Rate" across sex. Package ggplot2 is referred. 
o. Do ANOVA test for sex differences in "Bi.Weekly.Rate" in city "Hartford".
p. Explore the interaction of "Ethnic.Grp" and "Sex" versus "Bi.Weekly.Rate" using density ridges plot similar to Figure \@ref(fig:salary-EthnicSex1) and provide a succinct interpretation of the results.
```



