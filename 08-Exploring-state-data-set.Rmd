# State dataset

## Data Import and Manipulation

Welcome to the wild world of state datasets! We're time-traveling back to the groovy 1970s in the USA. Our mission? To explore three datasets: state.abb, state.x77, and state.region. Here's a snappy overview:

**state.abb**: A vector of 2-letter state name abbreviations. *"Who's CA? Oh, California!"* 

**state.x77**: A 50x8 matrix containing the following statistics in its columns:

- Population: population estimate as of July 1, 1975

- Income: per capita income (1974)

- Illiteracy: illiteracy (1970, percent of population)

- Life Exp: life expectancy in years (1969-71)

- Murder: murder and non-negligent manslaughter rate per 100,000 population (1976)

- HS Grad: percent high-school graduates (1970)

- Frost: mean number of days with minimum temperature below freezing (1931-1960) in capital or large city

- Area: land area in square miles

**state.region**:
A factor containing the regions (Northeast, South, North Central, West) that each state belongs to.

To avoid a data scavenger hunt, let's merge these three datasets into one mega data frame "sta" with 10 columns and 50 rows!

```{r}
tem <- data.frame(state.x77)               # Transform matrix into data frame
sta <- cbind(state.abb, tem, state.region) # Combine the three data sets
colnames(sta)[1] <- "State"                # Rename first column
colnames(sta)[10] <- "Region"              # Rename the 10th column
head(sta)
str(sta)
summary(sta)
```

## Visualizing data

Let's start by visualizing the distributions of numeric variables, where numbers transform into stories! In many cases, we want to know if our data follows a normal distribution or not so that we can decide whether some analysis methods are suitable or not. Let's dive into the world of histograms, Q-Q plots, and the intriguing Shapiro-Wilk test. Ready? Here we go!

- Histogram: Does the histogram approach a normal density curve? If yes, then the variable more likely follows a normal distribution.

- Q\-Q plot: Do the sample quantiles almost fall into a straight line? A yes here also hints a normal distribution.

- Shapiro-Wilk test: This is a widely used normality test. The null hypothesis is that a variable follows a normal distribution. A tiny p-value indicates a non-normality of the variable.

```{r message=FALSE, warning=FALSE, fig.width=8, fig.height=8}
a <- colnames(sta)[2:9] # Pick up all numeric columns/variables according to the names 
par(mfrow = c(4, 4))    # Layout outputs in 4 rows and 4 columns
for (i in 1:length(a)){ 
  sub = sta[a[i]][, 1]   # Extract corresponding variable a[i] in sta
  hist(sub, main = paste("Hist. of", a[i], sep = " "), xlab = a[i])
  qqnorm(sub, main = paste("Q-Q Plot of", a[i], sep = " ")) #
  qqline(sub)           # Add a QQ plot line. 
 
   if (i == 1) {
     s.t <- shapiro.test(sub) # Normality test for population
   } else {
     s.t <- rbind(s.t, shapiro.test(sub)) # Bind a new test result to previous row
 }
}
s.t <- s.t[, 1:2]       # Take the first two columns of shapiro.test result
s.t <- cbind(a, s.t)    # Add variable name for the result
s.t
```

From the histograms and QQ plots we can see that the distributions of Population, Illiteracy, and Area are doing a leftward lean. Income and Life.Exp, however, are playing it close to normal. The shapiro tests reveal Income, Life.Exp and Frost as normal party-goers with p-values greater than 0.05, while Murder and HS.Grad are almost normal, but not quite there. Population, Illiteracy, and Area, unfortunately, didn't get the normality invite.

Now, what about the categorical variable, region? Let's peek into how states are spread across regions.

(ref:state-region) State count in each region.

```{r state-region, fig.cap='(ref:state-region)', fig.align='center'}
counts <- sort(table(sta$Region), decreasing = TRUE)  # Number of states in each region
percentages <- 100 * counts / length(sta$Region)      
barplot(percentages, ylab = "Percentage", col = "lightblue") 
text(x=seq(0.7, 5, 1.2), 2, paste("n=", counts))      # Add count to each bar
```

The barplot tells us that we have relatively more states in the South(16) and fewer states in the Northeast(9). North Central and West are almost twins with 12 and 13 states respectively.

Ever heard of a lollipop plot? It's a hybrid of a scatter plot and a barplot. Here is the lollipop chart showcases the relationship between states and their population.

(ref:state-pop) Loppipop plot of the population in each state.

```{r state-pop, fig.cap='(ref:state-pop)', fig.align='center'}
library(ggplot2)
ggplot(sta, aes(x = State, y = Population)) +
  geom_point(size = 3, color = "red") + 
  geom_segment(aes(x = State, xend = State, y = 0, yend = Population)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) # Rotate axis label
```

Even back in the early days, California and New York were the hotspots, while South Dakota was more of a quiet retreat.

More Questions to Ponder: How did the murder rate vary across states and regions in those days? What influenced it? Could other factors explain the murder rate?
 

A choropleth map may give us an overall view.

(ref:state-map) Map of murder rate distribution.

```{r state-map, warning=FALSE, fig.cap='(ref:state-map)', fig.align='center'}
library(maps)
library(ggplot2)
sta$region <- tolower(state.name)  # Lowercase states' names
states <- map_data("state")        # Extract state data
map <- merge(states, sta, by = "region", all.x = T)  # Merge states and state.x77 data
map <- map[order(map$order), ]     # Must order first
ggplot(map, aes(x = long, y = lat, group = group)) +  
  geom_polygon(aes(fill = Murder)) +   
  geom_path() + 
  scale_fill_gradientn(colours = rev(heat.colors(10))) +
  coord_map() +
  labs(x = "Longitude", y = "Latitude") +
  guides(fill = guide_legend(title = "Murder Rate"))   
```

A glance at the map reveals a gradient of concern: redder shapes in the South and East, suggesting higher danger, while the North Central, Northwest, and Northeast appear calmer in yellow.

(ref:state-murder) Ridgeline plot for murder rate in each region.

```{r state-murder, warning=FALSE, message=FALSE, fig.cap='(ref:state-murder)', fig.align='center'}
library(ggridges)
ggplot(sta, aes(x = Murder, y = Region, fill = Region)) +
  geom_density_ridges() +
  theme_ridges() +                                 # No color on backgroud
  theme(legend.position = "none",                  # No show legend
        axis.title.x = element_text(hjust = 0.5),  # x axis title in the center
        axis.title.y = element_text(hjust = 0.5))  # y axis title in the center
```

The ridgeline plot confirms our map's story. South is leaning right with higher murder rates, while the other regions are more left-leaning.

>
```{exercise}

>
Similar to Figure \@ref(fig:state-map), weave your magic to craft an Illiteracy map using state.x77 data set and give a brief interpretation. Hint: Combine state.abb and state.x77 first or use the row names of state.x77 data set directly. You may start from importing the data:
>
tem <- data.frame(state.x77) 
>
sta <- cbind(state.abb, tem, state.region)
>
colnames(sta)[10] <- "Region" 
>
```

>
```{exercise}

>
Similar to Figure \@ref(fig:state-murder), conjure up a ridgeline plot to explore the regional distribution of Illiteracy using state.x77 and state.region data sets and interpret your figure.
```

## Analyzing the relationship among variables

A scatter matrix is a pair-wise scatter plot of multiple variables presented in a matrix format. It's perfect for eyeballing linear relationships among variables in a single plot. The correlation coefficient, ranging from -1 to 1, is the gossip scale. A -1 coefficient means two variables are in a bitter feud (think y=-x), while a 1 indicates a blossoming friendship (like y=2x+1). Now, let's peek into the lives of our state data variables.

(ref:state-corrplot) Corrplot for numeric variables.

```{r state-corrplot, warning=FALSE, message=FALSE, fig.width=6, fig.height=6, fig.cap='(ref:state-corrplot)', fig.align='center'}
st <- sta[, 2:9] # Take numeric variables as goal matrix
library(ellipse) 
library(corrplot)
corMatrix <- cor(as.matrix(st)) # Calculate correlation matrix
col <- colorRampPalette(c("red", "yellow", "blue"))  # 3 colors to represent coefficients -1 to 1.
corrplot.mixed(corMatrix, order = "AOE", lower = "number", lower.col = "black", 
               number.cex = .8, upper = "ellipse",  upper.col = col(10), 
               diag = "u", tl.pos = "lt", tl.col = "black") # Mix plots of "number" and "ellipse"
```

Look at the top-right of the correlation figure. A stark red, narrow ellipse between Murder and Life.Exp signalizes a high negative correlation. Conversely, the cozy blue showing between Murder and Illiteracy implies a high positive correlation. The red-orange hues between Murder and Frost, HS.Grad suggest a mild negative correlation. The orange shape between Murder and Income shows slight negative correlation. While light-blue tones between Murder and both Area and Population indicate a small positive correlation.

The pearson and spearman correlation matrix on the bottom-left gives us the r-values between each pair of the variables, which confirm the correlation details on the top-right.

Positive correlation between Murder and Illiteracy (r-value: 0.70) is like saying, "Less school, more trouble". Negative correlations between Murder and Life.Exp, Frost (r-values: -0.78, -0.54) can be interpreted as "More mayhem, shorter lifespans", and "Murderers dislike winter". Fascinating, isn't it?

>
```{exercise}

>
Similar to Figure \@ref(fig:state-corrplot), creat a scatter matrix among 7 variables: *mpg*, *cyl*, *disp*, *hp*, *drat*, *wt* and *qsec* in the data set *mtcars*. Give a brief interpretation of the plot.
```

Now let's see the cluster situation of these variables.

(ref:state-dendrogram) Cluster dendrogram for state numeric variables.

```{r state-dendrogram, fig.cap='(ref:state-dendrogram)', fig.align='center'}
plot(hclust(as.dist(1 - cor(as.matrix(st)))))  # Hierarchical clustering
```

The cluster Dendrogram reveals two clusters for these variables. Murder cozies up to Illiteracy mostly, and then to Population and Area. Meanwhile, HS.Grad prefers hanging out with Income mostly, then with Life.Exp and Frost. Though illiteracy and HS.Grad are in the different clusters, they share a bond: for the same state, the lower the illiteracy, the higher the high school graduation rate. An r-value of -0.66 between Illiteracy and HS.Grad in the corrplot confirms this clandestine relationship.

>
```{exercise}

>
Similar to Figure \@ref(fig:state-dendrogram), creat a cluster dendrogram of the 7 variables: *mpg*, *cyl*, *disp*, *hp*, *drat*, *wt* and *qsec* in the data set *mtcars*. What does your output reveal?
```

Now, who's ready to talk about illiteracy? Let's see a density plot about the distribution of Illiteracy by region.

(ref:state-illiteracy) Illiteracy distribution by region.

```{r state-illiteracy, fig.cap='(ref:state-illiteracy)', fig.align='center'}
ggplot(sta, aes(x = Illiteracy, fill = Region)) + geom_density(alpha = 0.3)
```

Here's a juicy tidbit: The North-Central region seems to have its illiteracy act together, mostly under 1%. While the south region has an open and bell-shaped distribution with illiteracy ranging from 0.5 to 3. Though region west has a spread out distribution too, it's left-skewed; Most west states keep illiteracy of less than 1% of their populations. The Northeast, mostly under 1.5%, is also keeping illiteracy on a short leash.

>
```{exercise}

>
Similar to Figure \@ref(fig:state-illiteracy), use density plot to explore the distribution of *mpg* by *cyl* in the data set *mtcars*. 
```

Because of the relationship of Murder with both Population and Area, now We add one more column of Pop.Density in the mix, which is the population per square miles of area.

(ref:state-population) Box plot of population density by region.

```{r state-population, fig.cap='(ref:state-population)', fig.align='center'}
sta$Pop.Density <- sta$Population/sta$Area
boxplot(sta$Pop.Density ~ sta$Region, xlab = "Region", ylab = "Population Density")
model <- aov(sta$Pop.Density ~ sta$Region, sta)
summary(model)
```

The box plot shows that the mean Pop.Density of Northeast is much more than the other regions, while West has the lowest mean Pop.Density. The ANOVA test with a p-value of 6.3e-06 gives us the evidence to reject the null hypothesis that the mean Pop.Densities are the same for different regions, which means at least one of the regional mean population densities is different from the others. Not all regional Pop.Densities are created equal. Scandalous!

But wait, there's more! Let's check out Illiteracy and Murder with a dash of Population per area, and the region too.

(ref:state-IlliteracyMurder) Scatterplot for illiteracy and murder sized by population density and colored by region.

```{r state-IlliteracyMurder, fig.cap='(ref:state-IlliteracyMurder)', fig.align='center'}
ggplot(sta, aes(x = Illiteracy, y = Murder)) + 
  geom_point(aes(size = Pop.Density, color = Region)) + 
  geom_smooth(method = 'lm',formula = y ~ x)  # Add regression line
```

The scatter plot shows that many Northeast states have big population densities but middle-of-the-road illiteracy rates compared with the states in the other three regions. Murder and illiteracy are positively correlated. Southern states take the spotlight with higher murder rates and illiteracy levels.

Because of the high correlation of murder and Life.Exp, we will take a look at the distribution of Life.Exp.

(ref:state-LifeExp) Regional life expectancy.

```{r state-LifeExp, fig.cap='(ref:state-LifeExp)', fig.align='center'}
ggplot(sta, aes(x = Region, y = Life.Exp, fill = Region)) + 
  geom_violin(trim = FALSE) + 
  geom_boxplot(width = 0.1)
```

On average, the south is singing the blues with a lower life expectancy than the other three regions. North Central, on the other hand, is living its best life with the highest Life.Exp. West has extending distribution with two long tails on each end, which means some west states have very long life expectancy, while some expect short life expectancy though they are in the same region.

Now, let's talk about murder's relationship drama with Life.Exp, HS.Grad, and Income.

First we categorize the income into 5 IncomeTypes.

(ref:state-LifeMurder) Relationship between murder rate and life expectancy, high school graduation, and income.

```{r state-LifeMurder, warning=FALSE, message=FALSE, fig.cap='(ref:state-LifeMurder)', fig.align='center'}
library(dplyr)
# Group income into IncomeType first
sta.income <- sta %>% mutate(IncomeType = factor(ifelse(Income < 3500, "Under3500",  
                             ifelse(Income < 4000 & Income >= 3500, "3500-4000",
                               ifelse(Income < 4500 & Income >= 4000, "4000-4500",
                                 ifelse(Income < 5000 & Income >= 4500, "4500-5000", 
                                   "Above5000"))))))
ggplot(sta.income, aes(x = Murder, y = Life.Exp)) + 
  geom_point(aes(shape = IncomeType, color = Region, size = HS.Grad)) + 
  geom_smooth(method = 'lm', formula = y ~ x)
```

Murder rate is negatively correlated with Life.Exp. Those small symbols with high murder rates? They're from the South with lower HS.Grad rates and lower Life.Exp.

Left-skewing of most square and triangle symbols hints that wealthier states are often less murderous. But it's a complex factor, some high income states with incomes above 5000 and cross symbols had high Murder rate too(close to 12). 

>
```{exercise}

>
Now it's your turn to be the director. Use a scatter plot to analyze the correlation between Illiteracy and those variables in the other cluster shown in Figure \@ref(fig:state-dendrogram). Interpret your plot.
```

## The whole picture of the data set 

We’ve been analyzing the connections between murder rate and the various other variables in both clusters. It turns out that all variables are correlated, more or less. Now, let’s take a helicopter view and see the whole landscape of these variables. Ready for some heat maps and starry diagrams?

(ref:state-heatmap) Heat map for whole state data set.

```{r state-heatmap, message=FALSE, warning=FALSE, fig.width=8, fig.height=10, fig.cap='(ref:state-heatmap)', fig.align='center'}
library(gplots)
st.matrix <- as.matrix(st)    # Transfer the data frame to matrix
s <- apply(st.matrix, 2, function(y)(y - mean(y)) / sd(y))  # Standardize data
a <- heatmap.2(s, 
          col = greenred(75), # Color green red
          density.info = "none", 
          trace = "none", 
          scale = "none", 
          RowSideColors = rainbow(4)[sta$Region],  
          srtCol = 45,        # Column labels at 45 degree
          margins = c(5, 8),  # Bottom and right margins
          lhei = c(5, 15)     # Relative heights of the rows
) 
legend("topright", levels(sta$Region), fill = rainbow(4), cex = 0.8)  # Add legend 
```

Much like the cluster Dendrogram plot, Heatmap shows two clusters: Life.Exp, Income, HS.Grad, together with Frost build one cluster, while Illiteracy, Murder, Population, and Area build another cluster.

Compared with other states, lots of southern states with lower Life.Exp, Income, and HS.Grad have higher Murder rates and Illiteracy(Look at Mississippi and Alabama!). On the flip side, some northern and western states, like Nebraska and South Dakota, are living a higher Life.Exp, Income, and HS.Grad but lower Area, Population, Murder, and Illiteracy. South Dakota's income, though, is a bit green with envy.

(ref:state-segment) Segment diagram for all states.

```{r state-segment, fig.width=8, fig.height=8, fig.cap='(ref:state-segment)', fig.align='center'}
row.names(st) <- sta$State
stars(st, key.loc = c(13, 1.5), draw.segments = T)   
```

The segment Diagram reveals different facets of each state. Take South Dakota, for instance. It boasts big Frost(yellow), high Life Expectancy(blue), a solid high school graduation rate(pink) and good income(red). On the other side, it has a small area and population. Thankfully, the illiteracy and murder rate are very tiny compared with the other states.

Let's dive deeper with principal components analysis!
```{r}
pca = prcomp(st, scale = T)  # scale = T to normalize the data
pca
plot(pca)     # Plot the amount of variance each principal components captures
summary(pca)  # Show the importance of the components
percentVar <- round(100 * summary(pca)$importance[2, 1:7], 0) # Compute % variances
percentVar
```

The first two components are the big cheeses, contributing 45% and 20% of the variance, respectively, collectively account for 65% of the overall variance. The third component, slightly less impactful,still holds 10% of the total variance. The bar plot illustrates the dominance of each individual component.

(ref:state-bioplot) Biplot for PCA. 

```{r state-bioplot, warning=FALSE, fig.cap='(ref:state-bioplot)', fig.align='center'}
library(ggfortify)
row.names(sta) <- sta$State
autoplot(prcomp(st,  scale = T), data = sta, 
         colour = 'Region', shape = FALSE, label = TRUE, label.size = 3.5,
         loadings = TRUE, loadings.colour = 'blue', loadings.label = TRUE, 
         loadings.label.size = 4, loadings.label.colour = 'blue')
```

The biplot is like our data's own reality show, illustrating the special roles of these variables to the component of the variance. Illiteracy positively contributes to variance PC1, while Life.Exp and Frost play a contrasting negative role with PC1. Additionally, Area significantly influences the positive variance in PC2. The other four variables exhibit both sides role, contributing positively or negatively to PC1 and PC2.
Drama ensues as Southern states like Louisiana (LA) and Mississippi (MS) showcase their Illiteracy and Murder rates, while North-Central states like Minnesota (MN) and North Dakota (ND) boast their high Life Expectancy and Frost. Alaska (AK) and California (CA) from the West region flaunt their Big Area feature.

## Linear model analysis
Ready to play detective with numbers? Let's explore the fascinating realm of linear models to unravel the mystery behind the murder rate. We're dropping HS.Grad and Frost out of our suspect list due to their high correlation with other variables.
```{r}
lm.data <- sta[, c(2:6, 9:10)]
lm.data <- within(lm.data, Region <- relevel(Region, ref = "South"))  # Set region South as reference
model <- lm(Murder ~ .,  data = lm.data)
summary(model)
```

The prime suspects in influencing the murder rate turn out to be Life Expectancy, Population, and Illiteracy, with the region playing the role of an accessory. Here's the lowdown: for every step up in Life Expectancy, the murder rate drops by 1.445 units. Conversely, Population and Illiteracy are playing the villains, pushing up the murder rate by 0.000259 and 1.861 units, respectively. Being in the Northeast gets you a 2.673-unit markdown on murder rates. Our model is a rival Sherlock, explaining 82% of the variance in murder rates. Here's the formula to predict the murder rate:

Murder=105.9-1.445$*Life.Exp+0.000259*$Population+1.861$*Illiteracy-2.673*$RegionNortheast

>
```{exercise}

>
Your turn to wear the detective hat! Analyze a linear model for Illiteracy and interpret your result. Hint: Check the corrplot figure \@ref(fig:state-corrplot) and pay attention to the high correlation between murder rate and life expectancy.
```

## Conclusion

-The southern region shows a higher murder rate with lower life expectancy, income, and high school graduation rate but a higher illiteracy rate. Conversely, the northern region is all about lower murder rate with higher population density, life expectancy, income, and high school graduation rate accompanied by lower illiteracy. 

-Fun fact: Data on life expectancy, population, illiteracy of the state in the 1970s, along with regional affiliations, can help you guess its murder rate from those days. Quite the narrative power vested in numbers, right?

That's a wrap! Remember, in the world of data, there's always a story waiting to be told. Happy analyzing!
